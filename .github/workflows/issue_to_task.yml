name: Issue -> Task Spec

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  create_task_spec_pr:
    if: github.event.label.name == 'agent:ready'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create task spec PR
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issueNumber = issue.number;
            const safeTitle = (issue.title || `issue-${issueNumber}`)
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/(^-|-$)/g, '')
              .slice(0, 60);

            const branchName = `tasks/issue-${issueNumber}-${safeTitle}`;
            const taskPath = `tasks/issue-${issueNumber}.md`;

            // If task already exists, no-op.
            try {
              await github.rest.repos.getContent({ owner, repo, path: taskPath });
              core.info(`Task file already exists at ${taskPath}; skipping.`);
              return;
            } catch (e) {
              // Continue if not found
              if (e.status !== 404) throw e;
            }

            // Get default branch SHA
            const { data: repoData } = await github.rest.repos.get({ owner, repo });
            const baseBranch = repoData.default_branch;
            const { data: baseRef } = await github.rest.git.getRef({ owner, repo, ref: `heads/${baseBranch}` });
            const baseSha = baseRef.object.sha;

            // Create branch
            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/heads/${branchName}`,
              sha: baseSha,
            });

            const body = (issue.body || '').trim();
            const issueUrl = issue.html_url;

            const content = `# Task: ${issue.title}\n\n## Source\n- GitHub Issue: ${issueUrl}\n\n## Context\n${body ? body : '(add context from issue)'}\n\n## Acceptance Criteria (must be testable)\n- [ ] (fill in)\n\n## Test selection guide\nPick the cheapest test that proves the change:\n\n1) **Backend unit/service tests (pytest)**: business logic, helpers.\n2) **Backend API contract tests (pytest + FastAPI TestClient)**: endpoints, validation, responses.\n3) **Frontend component tests (Vitest/Jest + React Testing Library)**: UI behavior (if web frontend exists).\n4) **E2E smoke (Playwright)**: only for critical cross-stack flows.\n\n## How to test locally\n- Backend: \`python -m pytest\`\n- Frontend (if applicable): \`npm test\`\n\n## Notes / Constraints\n- Keep PR small and focused.\n- If acceptance criteria canâ€™t be tested, mark task as blocked and explain why.\n`;

            // Create file
            const encoded = Buffer.from(content, 'utf8').toString('base64');
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: taskPath,
              message: `Add task spec for issue #${issueNumber}`,
              content: encoded,
              branch: branchName,
            });

            // Open PR
            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title: `Task spec: #${issueNumber} ${issue.title}`,
              head: branchName,
              base: baseBranch,
              body: `Auto-generated task spec for #${issueNumber}.\n\n- This PR was created when the issue was labeled **agent:ready**.`,
            });

            core.info(`Created PR: ${pr.data.html_url}`);
